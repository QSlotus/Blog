let currentController=null;async function sha256(t){const e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map((t=>t.toString(16).padStart(2,"0"))).join("")}async function generateAISummary(){const t=document.getElementById("ai-output");if(!t)return;currentController&&currentController.abort(),currentController=new AbortController;const e=currentController.signal;if(void 0===window.articleTitle||void 0===window.articleContent)return void console.warn("Article data not yet available");t.innerHTML='\n        <div class="flex items-center gap-2">\n            正在生成中...\n        </div>';const n="文章标题："+window.articleTitle+"；文章内容："+window.articleContent;try{const o=await sha256(n),r=encodeURIComponent(location.pathname),a=await fetch(`https://summary.qiusyan.top/is_uploaded?id=${r}&sign=${encodeURIComponent(o)}`,{signal:e});if(e.aborted)return;if("yes"===await a.text()){const n=await fetch(`https://summary.qiusyan.top/get_summary?id=${r}&sign=${encodeURIComponent(o)}`,{signal:e});if(e.aborted)return;const a=await n.text();t&&(t.textContent=a)}else{if(await fetch(`https://summary.qiusyan.top/upload_blog?id=${r}`,{method:"POST",body:n,signal:e}),e.aborted)return;const a=new EventSource(`https://summary.qiusyan.top/summary?id=${r}`);t&&(t.textContent=""),e.addEventListener("abort",(()=>{a.close()})),a.onmessage=n=>{if(t&&!e.aborted)if("[DONE]"!==n.data)try{const e=JSON.parse(n.data);t.textContent+=e.response}catch(t){console.error("Error parsing SSE message:",t)}else a.close();else a.close()},a.onerror=()=>{a.close(),!t||t.textContent||e.aborted||(t.textContent="摘要生成失败，请稍后刷新页面重试。")},fetch(`https://summary.qiusyan.top/get_summary?id=${r}&sign=${encodeURIComponent(o)}`,{signal:e})}}catch(n){if("AbortError"===n.name)return;console.error("AI Summary Error:",n),t&&!e.aborted&&(t.textContent="摘要生成失败，请稍后刷新页面重试。")}}function initAISummary(){if(!document.getElementById("ai-output"))return;if(void 0!==window.articleTitle&&void 0!==window.articleContent)return void generateAISummary();let t=0;const e=setInterval((()=>{if(void 0!==window.articleTitle&&void 0!==window.articleContent)return clearInterval(e),void generateAISummary();if(t++,t>=5){clearInterval(e),console.error("Failed to load article data after multiple attempts");const t=document.getElementById("ai-output");t&&(t.textContent="无法加载文章数据，请刷新页面重试。")}}),1e3)}function cleanup(){currentController&&(currentController.abort(),currentController=null)}document.addEventListener("DOMContentLoaded",initAISummary),"undefined"!=typeof swup&&(swup.hooks.on("page:view",(()=>{cleanup(),initAISummary()})),swup.hooks.on("content:replace",cleanup));let lastPath=location.pathname;const observer=new MutationObserver((()=>{location.pathname!==lastPath&&(lastPath=location.pathname,cleanup(),initAISummary())}));observer.observe(document.body,{childList:!0,subtree:!0});